<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Art Studio</title>
    
    <!-- Configura√ß√µes PWA e iOS -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Art Studio" />
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lucasmaia2709-lang/fotoparapintar/refs/heads/main/logo.jpg" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              display: ['"Fredoka"', 'cursive'],
              body: ['"Nunito"', 'sans-serif'],
            },
            colors: {
              primary: '#4f46e5', // Indigo
              secondary: '#fbbf24', // Amber
            }
          }
        }
      }
    </script>

    <style>
      body {
        font-family: 'Nunito', sans-serif;
        background-color: #f8fafc; /* Slate 50 */
        color: #1e293b; /* Slate 800 */
        overscroll-behavior-y: none;
      }
      
      h1, h2, h3, button {
        font-family: 'Fredoka', sans-serif;
      }

      /* Loader Simples */
      .loader {
        border: 4px solid #e2e8f0;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
      }

      .image-container img,
      .image-container canvas {
        max-height: 400px;
        width: auto;
        max-width: 100%;
        border-radius: 1rem;
        object-fit: contain;
      }
      
      /* --- TELA DE PINTURA --- */
      #paint-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-in-out;
      }
      #paint-modal.visible {
        opacity: 1;
        pointer-events: auto;
      }
      #paint-canvas-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #f1f5f9;
        position: relative;
      }
      #paint-canvas {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        background-color: white;
        touch-action: none; 
      }
      .paint-toolbar {
        background: white;
        padding: 1rem;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
      }
      
      /* Input de Cor Customizado */
      .color-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 0 0 2px #cbd5e1;
        position: relative;
        overflow: hidden;
      }
      input[type='color'] {
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        cursor: pointer;
        border: none;
        padding: 0;
        margin: 0;
      }

      body.modal-open {
        overflow: hidden;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- AUTENTICA√á√ÉO -->
    <section id="auth-section" class="w-full max-w-md card p-8 text-center">
      <div class="mb-6 flex justify-center">
        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-3xl">üé®</div>
      </div>
      <h1 class="text-3xl font-bold text-slate-800 mb-2">Bem-vindo ao Studio</h1>
      <p class="text-slate-500 mb-8">Fa√ßa login para come√ßar a criar.</p>

      <form id="login-form" class="space-y-4 text-left">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
          <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="seu@email.com">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Senha</label>
          <input type="password" id="login-password" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-transform active:scale-95 shadow-lg shadow-indigo-500/30">
          Entrar
        </button>
      </form>

      <form id="register-form" class="space-y-4 text-left hidden">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Email</label>
          <input type="email" id="register-email" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="seu@email.com">
        </div>
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-1">Criar Senha</label>
          <input type="password" id="register-password" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition-transform active:scale-95 shadow-lg shadow-green-500/30">
          Criar Conta
        </button>
      </form>

      <div class="mt-6 pt-6 border-t border-slate-100">
        <button id="auth-toggle-link" class="text-indigo-600 font-semibold hover:underline">
          N√£o tem conta? Crie aqui.
        </button>
      </div>
      <p id="auth-error" class="text-red-500 mt-4 text-sm font-semibold"></p>
    </section>

    <!-- APP PRINCIPAL -->
    <section id="app-content" class="w-full max-w-5xl hidden pb-20">
      
      <!-- Navbar -->
      <nav class="flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex items-center gap-2">
          <span class="text-2xl">‚úèÔ∏è</span>
          <h1 class="text-xl font-bold text-slate-800">Art Studio</h1>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <span class="block text-xs text-slate-400 font-bold uppercase">Cr√©ditos</span>
            <span id="credits-display" class="block font-bold text-indigo-600 leading-none text-lg">0</span>
          </div>
          <button id="logout-button" class="p-2 text-slate-400 hover:text-red-500 bg-slate-50 rounded-lg hover:bg-red-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </nav>

      <!-- √Årea de Upload -->
      <div class="mb-8">
        <label for="image-upload" class="cursor-pointer block w-full bg-white border-2 border-dashed border-slate-300 rounded-3xl p-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition-all group">
          <div class="w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-indigo-100 group-hover:text-indigo-500 transition-colors">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          </div>
          <h3 class="text-xl font-bold text-slate-700 group-hover:text-indigo-700">Escolha uma Foto</h3>
          <p class="text-slate-400 mt-1">Toque aqui para fazer upload</p>
          <input type="file" id="image-upload" accept="image/*" class="hidden">
        </label>
      </div>

      <!-- Resultados -->
      <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
        <!-- Original -->
        <div class="card p-4">
          <h3 class="font-bold text-slate-500 mb-3 text-sm uppercase tracking-wide px-2">Original</h3>
          <div id="original-image-container" class="bg-slate-50 rounded-xl min-h-[250px] flex items-center justify-center border border-slate-100"></div>
        </div>

        <!-- Gerado -->
        <div class="card p-4 border-indigo-100 ring-4 ring-indigo-50">
          <h3 class="font-bold text-indigo-600 mb-3 text-sm uppercase tracking-wide px-2 flex items-center gap-2">
            <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span> Desenho
          </h3>
          <div id="generated-image-container" class="bg-white rounded-xl min-h-[250px] flex items-center justify-center">
             <p class="text-slate-400 text-sm">Aguardando...</p>
          </div>
          
          <!-- A√ß√µes -->
          <div id="action-buttons" class="mt-4 grid grid-cols-2 gap-3 hidden">
            <button id="save-button" class="bg-white border-2 border-slate-200 text-slate-700 hover:border-slate-300 hover:bg-slate-50 font-bold py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
               Salvar
            </button>
            <button id="paint-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 transition-transform active:scale-95 flex items-center justify-center gap-2">
               <span>üé®</span> Pintar
            </button>
          </div>
        </div>
      </div>

      <div class="mt-8 text-center">
         <div id="error-message" class="inline-block bg-red-50 text-red-500 px-4 py-2 rounded-lg text-sm font-bold hidden mb-4"></div>
         
         <button id="generate-button" class="hidden w-full sm:w-auto bg-slate-800 hover:bg-black text-white text-lg font-bold py-4 px-12 rounded-full shadow-xl transition-transform transform hover:scale-105">
           ‚ú® Transformar Foto
         </button>
      </div>

    </section>

    <!-- MODAL DE PINTURA (Fullscreen Mobile) -->
    <div id="paint-modal">
      <!-- Topo -->
      <div class="flex justify-between items-center p-4 bg-white border-b border-slate-100 shadow-sm z-10">
        <h3 class="font-bold text-lg text-slate-800">Pintura</h3>
        <div class="flex gap-2">
           <button id="download-painted-button" class="bg-green-100 text-green-700 p-2 rounded-lg font-bold text-sm hover:bg-green-200">
             Salvar
           </button>
           <button id="close-paint-modal" class="bg-slate-100 text-slate-700 p-2 rounded-lg font-bold text-sm hover:bg-slate-200">
             Fechar
           </button>
        </div>
      </div>

      <!-- Canvas Area -->
      <div id="paint-canvas-container">
        <canvas id="paint-canvas"></canvas>
      </div>

      <!-- Toolbar Inferior -->
      <div class="paint-toolbar safe-area-bottom">
        <div class="flex items-center gap-4">
           <span class="text-sm font-bold text-slate-500 uppercase tracking-wider">Escolha a Cor:</span>
           <div class="color-btn bg-white">
             <input type="color" id="color-picker" value="#4f46e5" />
           </div>
           <div class="text-xs text-slate-400 ml-2">Toque na bola<br>para mudar</div>
        </div>
      </div>
    </div>

    <script>
      // SW
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(() => {}));
      }

      const CLOUDFLARE_WORKER_URL = 'https://fotoparapintar.lucasabreucotefis.workers.dev';

      // UI References
      const authSection = document.getElementById('auth-section');
      const appContent = document.getElementById('app-content');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const authToggleLink = document.getElementById('auth-toggle-link');
      const authError = document.getElementById('auth-error');
      const logoutButton = document.getElementById('logout-button');
      const creditsDisplay = document.getElementById('credits-display');
      
      const imageUpload = document.getElementById('image-upload');
      const resultsSection = document.getElementById('results');
      const originalImageContainer = document.getElementById('original-image-container');
      const generatedImageContainer = document.getElementById('generated-image-container');
      const generateButton = document.getElementById('generate-button');
      const errorMessageDiv = document.getElementById('error-message');
      const actionButtonsContainer = document.getElementById('action-buttons');
      const saveButton = document.getElementById('save-button');
      const paintButton = document.getElementById('paint-button');
      
      const paintModal = document.getElementById('paint-modal');
      const paintCanvas = document.getElementById('paint-canvas');
      const colorPicker = document.getElementById('color-picker');
      const closePaintModalButton = document.getElementById('close-paint-modal');
      const downloadPaintedButton = document.getElementById('download-painted-button');

      let currentUser = null;
      let lastBase64Image = null;
      let generatedImageDataUrl = null;

      // Auth Logic
      window.addEventListener('load', () => {
        currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) showApp();
        else showAuth();
      });

      authToggleLink.addEventListener('click', (e) => {
        e.preventDefault();
        const isLogin = !loginForm.classList.contains('hidden');
        loginForm.classList.toggle('hidden', isLogin);
        registerForm.classList.toggle('hidden', !isLogin);
        authToggleLink.textContent = isLogin ? "J√° tem conta? Entre aqui." : "N√£o tem conta? Crie aqui.";
        authError.textContent = '';
      });

      const handleAuth = async (endpoint, emailId, passId) => {
        authError.textContent = '';
        const email = document.getElementById(emailId).value.trim();
        const password = document.getElementById(passId).value;
        try {
          const res = await fetch(`${CLOUDFLARE_WORKER_URL}/${endpoint}`, {
             method: 'POST', headers: {'Content-Type': 'application/json'},
             body: JSON.stringify({email, password})
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Erro na autentica√ß√£o');
          
          if (endpoint === 'register') {
            alert('Conta criada! Fa√ßa login.');
            authToggleLink.click();
          } else {
            currentUser = { email, credits: data.credits };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
          }
        } catch (err) { authError.textContent = err.message; }
      };

      loginForm.addEventListener('submit', e => { e.preventDefault(); handleAuth('login', 'login-email', 'login-password'); });
      registerForm.addEventListener('submit', e => { e.preventDefault(); handleAuth('register', 'register-email', 'register-password'); });
      
      logoutButton.addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showAuth();
        resetUI();
      });

      function showApp() { authSection.classList.add('hidden'); appContent.classList.remove('hidden'); updateCredits(); }
      function showAuth() { appContent.classList.add('hidden'); authSection.classList.remove('hidden'); }
      function updateCredits() { if(currentUser) creditsDisplay.textContent = currentUser.credits; }
      
      function resetUI() {
        resultsSection.classList.add('hidden');
        originalImageContainer.innerHTML = '';
        generatedImageContainer.innerHTML = '<p class="text-slate-400 text-sm">Aguardando...</p>';
        generateButton.classList.add('hidden');
        actionButtonsContainer.classList.add('hidden');
        errorMessageDiv.classList.add('hidden');
        imageUpload.value = '';
      }

      // Image Handling
      imageUpload.addEventListener('change', async (ev) => {
        const file = ev.target.files[0];
        if(!file) return;
        
        const preview = await fileToBase64(file);
        originalImageContainer.innerHTML = `<img src="${preview}" class="w-full h-full object-contain">`;
        resultsSection.classList.remove('hidden');
        generateButton.classList.remove('hidden');
        
        // Reset generated area
        generatedImageContainer.innerHTML = '<div class="text-center"><span class="text-3xl animate-bounce block mb-2">‚ú®</span><span class="text-slate-500 font-bold">Pronto!</span></div>';
        actionButtonsContainer.classList.add('hidden');
        
        lastBase64Image = await resizeImageFile(file, 1024);
        
        // Scroll to button
        setTimeout(() => generateButton.scrollIntoView({behavior:'smooth', block:'center'}), 100);
      });

      generateButton.addEventListener('click', async () => {
        if(!currentUser) return alert('Fa√ßa login');
        if(!lastBase64Image) return alert('Selecione uma imagem');
        
        generateButton.disabled = true;
        generateButton.classList.add('opacity-50');
        generatedImageContainer.innerHTML = '<div class="loader"></div>';
        errorMessageDiv.classList.add('hidden');

        try {
           const { dataUrl, mimeType } = lastBase64Image;
           const resp = await fetch(`${CLOUDFLARE_WORKER_URL}/generate-image`, {
             method: 'POST', headers: {'Content-Type': 'application/json'},
             body: JSON.stringify({ imageData: dataUrl.split(',')[1], mimeType, userEmail: currentUser.email })
           });
           const data = await resp.json();
           if(!resp.ok) throw new Error(data.error || 'Erro ao gerar');

           generatedImageDataUrl = `data:image/png;base64,${data.imageBase64}`;
           generatedImageContainer.innerHTML = `<img src="${generatedImageDataUrl}" class="w-full h-full object-contain">`;
           actionButtonsContainer.classList.remove('hidden');
           
           currentUser.credits = data.credits;
           localStorage.setItem('currentUser', JSON.stringify(currentUser));
           updateCredits();
        } catch(err) {
           errorMessageDiv.textContent = err.message;
           errorMessageDiv.classList.remove('hidden');
           generatedImageContainer.innerHTML = '‚ùå';
        } finally {
           generateButton.disabled = false;
           generateButton.classList.remove('opacity-50');
        }
      });

      // Saving & Painting
      saveButton.addEventListener('click', () => {
        const a = document.createElement('a');
        a.href = generatedImageDataUrl;
        a.download = 'desenho.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      paintButton.addEventListener('click', () => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
           const ctx = paintCanvas.getContext('2d', { willReadFrequently: true });
           
           // Maximize fit
           const container = document.getElementById('paint-canvas-container');
           const maxWidth = container.clientWidth - 20;
           const maxHeight = container.clientHeight - 20;
           
           let w = img.width, h = img.height;
           const ratio = Math.min(maxWidth/w, maxHeight/h);
           w *= ratio; h *= ratio;
           
           paintCanvas.width = w; paintCanvas.height = h;
           ctx.drawImage(img, 0, 0, w, h);
           
           paintModal.classList.add('visible');
           document.body.classList.add('modal-open');
        };
        img.src = generatedImageDataUrl;
      });

      closePaintModalButton.addEventListener('click', () => {
        paintModal.classList.remove('visible');
        document.body.classList.remove('modal-open');
      });

      downloadPaintedButton.addEventListener('click', () => {
         const a = document.createElement('a');
         a.href = paintCanvas.toDataURL('image/png');
         a.download = 'minha-arte.png';
         document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      // Flood Fill
      const getPixel = (ctx, x, y) => {
         const p = ctx.getImageData(x, y, 1, 1).data;
         return {r:p[0], g:p[1], b:p[2], a:p[3]};
      };
      const match = (c1, c2) => Math.abs(c1.r-c2.r)<50 && Math.abs(c1.g-c2.g)<50 && Math.abs(c1.b-c2.b)<50;
      const hexToRgb = (h) => ({r: parseInt(h.slice(1,3),16), g: parseInt(h.slice(3,5),16), b: parseInt(h.slice(5,7),16), a:255});

      const fill = (ctx, sx, sy, color) => {
         const imgData = ctx.getImageData(0,0, ctx.canvas.width, ctx.canvas.height);
         const w = imgData.width, h = imgData.height;
         const startColor = getPixel(ctx, sx, sy);
         
         if(startColor.r+startColor.g+startColor.b < 100) return; // Black line check
         
         const stack = [[sx, sy]];
         while(stack.length) {
            const [x, y] = stack.pop();
            const idx = (y*w + x)*4;
            if(x<0||x>=w||y<0||y>=h) continue;
            
            const r = imgData.data[idx], g = imgData.data[idx+1], b = imgData.data[idx+2];
            if(match({r,g,b}, startColor) && !match({r,g,b}, color)) {
               imgData.data[idx] = color.r; imgData.data[idx+1] = color.g;
               imgData.data[idx+2] = color.b; imgData.data[idx+3] = 255;
               stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
         }
         ctx.putImageData(imgData, 0, 0);
      };

      const handlePaint = (cx, cy) => {
         const rect = paintCanvas.getBoundingClientRect();
         const x = Math.floor((cx - rect.left) * (paintCanvas.width/rect.width));
         const y = Math.floor((cy - rect.top) * (paintCanvas.height/rect.height));
         fill(paintCanvas.getContext('2d'), x, y, hexToRgb(colorPicker.value));
      };

      paintCanvas.addEventListener('mousedown', e => handlePaint(e.clientX, e.clientY));
      paintCanvas.addEventListener('touchstart', e => {
         if(e.touches.length) { e.preventDefault(); handlePaint(e.touches[0].clientX, e.touches[0].clientY); }
      }, {passive: false});

      // Helpers
      const fileToBase64 = file => new Promise((res,rej) => {
         const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
      });
      const resizeImageFile = async (file, max=1024) => {
         const url = await fileToBase64(file);
         return new Promise(res => {
            const img = new Image();
            img.onload = () => {
               let w=img.width, h=img.height;
               if(w>max||h>max) { const r=Math.min(max/w, max/h); w*=r; h*=r; }
               const c = document.createElement('canvas'); c.width=w; c.height=h;
               c.getContext('2d').drawImage(img,0,0,w,h);
               res({dataUrl: c.toDataURL(file.type), mimeType: file.type});
            };
            img.src = url;
         });
      };
    </script>
  </body>
</html>
