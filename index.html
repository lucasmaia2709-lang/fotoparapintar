<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Desenhos para Colorir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Baloo 2', cursive; background-color: #f0f9ff; }
    .color-palette { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
    .color-swatch { width: 30px; height: 30px; border-radius: 0.25rem; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.5); transition: transform 0.2s; }
    .color-swatch.selected { transform: scale(1.2); border-color: #38bdf8; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<main class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl max-w-5xl w-full">

  <!-- LOGIN -->
  <div id="auth-section">
    <h1 class="text-3xl font-bold text-center text-sky-600">Login / Registro</h1>
    <form id="login-form" class="mt-6">
      <input type="email" id="login-email" placeholder="Seu email" required class="border rounded w-full py-2 px-4 mb-3">
      <input type="password" id="login-password" placeholder="Senha" required class="border rounded w-full py-2 px-4 mb-3">
      <button type="submit" class="w-full bg-green-500 text-white py-2 rounded">Entrar</button>
    </form>
    <form id="register-form" class="hidden mt-6">
      <input type="email" id="register-email" placeholder="Seu email" required class="border rounded w-full py-2 px-4 mb-3">
      <input type="password" id="register-password" placeholder="Senha" required class="border rounded w-full py-2 px-4 mb-3">
      <button type="submit" class="w-full bg-sky-500 text-white py-2 rounded">Registrar</button>
    </form>
    <p class="text-center mt-4">
      <a href="#" id="auth-toggle-link" class="text-sky-600">NÃ£o tem conta? Registre-se</a>
    </p>
    <p id="auth-error" class="text-red-500 text-center mt-2"></p>
  </div>

  <!-- APP -->
  <div id="app-content" class="hidden">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-sky-600">Gerador de Desenhos ðŸŽ¨</h1>
      <div>
        <span id="credits-display" class="mr-4 font-bold">CrÃ©ditos: 0</span>
        <button id="logout-button" class="bg-red-500 text-white px-3 py-1 rounded">Sair</button>
      </div>
    </div>

    <label for="image-upload" class="bg-yellow-400 px-4 py-2 rounded cursor-pointer">Selecionar Imagem</label>
    <input type="file" id="image-upload" accept="image/*" class="hidden">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
      <div class="text-center">
        <h2 class="font-semibold mb-2">Imagem Original</h2>
        <div id="original-image-container" class="border rounded p-2 min-h-[250px] flex items-center justify-center"></div>
      </div>
      <div class="text-center">
        <h2 class="font-semibold mb-2">Desenho</h2>
        <canvas id="canvas" width="400" height="400" class="border rounded hidden"></canvas>
        <div id="generated-image-container" class="border rounded p-2 min-h-[250px] flex items-center justify-center"></div>
        <div id="color-palette" class="color-palette hidden mt-3">
          <div class="color-swatch" style="background:#f87171" data-color="#f87171"></div>
          <div class="color-swatch" style="background:#4ade80" data-color="#4ade80"></div>
          <div class="color-swatch" style="background:#60a5fa" data-color="#60a5fa"></div>
          <div class="color-swatch" style="background:#facc15" data-color="#facc15"></div>
          <div class="color-swatch" style="background:#ffffff; border:1px solid #ccc" data-color="#ffffff"></div>
        </div>
      </div>
    </div>

    <button id="generate-button" class="mt-6 bg-sky-600 text-white px-6 py-2 rounded">Gerar Desenho</button>
    <p id="error-message" class="text-red-500 mt-3 text-center"></p>
  </div>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // CONFIG FIREBASE (troque pelas suas chaves!)
  const firebaseConfig = {
    apiKey: "AIzaSyD6Jdnkfql5Ou6Na_BI8zDF6L2a_3JRZsY",
    authDomain: "fotoparapintar.firebaseapp.com",
    projectId: "fotoparapintar",
    storageBucket: "fotoparapintar.appspot.com",
    messagingSenderId: "353615488725",
    appId: "1:353615488725:web:xxxxxx"
  };

  const GEMINI_API_KEY = "AIzaSyBo90fWoREhClB8W3fuI4mD8_eEDrPYrKo";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authSection = document.getElementById("auth-section");
  const appContent = document.getElementById("app-content");
  const loginForm = document.getElementById("login-form");
  const registerForm = document.getElementById("register-form");
  const toggleLink = document.getElementById("auth-toggle-link");
  const authError = document.getElementById("auth-error");
  const logoutButton = document.getElementById("logout-button");
  const creditsDisplay = document.getElementById("credits-display");

  let currentUser = null;
  let credits = 0;

  // TROCA ENTRE LOGIN E REGISTRO
  toggleLink.addEventListener("click", (e) => {
    e.preventDefault();
    loginForm.classList.toggle("hidden");
    registerForm.classList.toggle("hidden");
    toggleLink.textContent = loginForm.classList.contains("hidden") ? "JÃ¡ tem conta? FaÃ§a login" : "NÃ£o tem conta? Registre-se";
  });

  // LOGIN
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      authError.textContent = err.message;
    }
  });

  // REGISTRO
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("register-email").value;
    const password = document.getElementById("register-password").value;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), { credits: 5 });
    } catch (err) {
      authError.textContent = err.message;
    }
  });

  // LOGOUT
  logoutButton.addEventListener("click", () => {
    signOut(auth);
  });

  // LISTENER LOGIN
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      authSection.classList.add("hidden");
      appContent.classList.remove("hidden");

      const userDoc = doc(db, "users", user.uid);
      const snap = await getDoc(userDoc);
      if (!snap.exists()) {
        await setDoc(userDoc, { credits: 5 });
      }
      onSnapshot(userDoc, (docSnap) => {
        credits = docSnap.data().credits;
        creditsDisplay.textContent = `CrÃ©ditos: ${credits}`;
      });
    } else {
      currentUser = null;
      authSection.classList.remove("hidden");
      appContent.classList.add("hidden");
    }
  });

  // ================== UPLOAD IMAGEM ==================
  const imageUpload = document.getElementById("image-upload");
  const originalContainer = document.getElementById("original-image-container");
  const generatedContainer = document.getElementById("generated-image-container");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let uploadedImage = null;

  imageUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      originalContainer.innerHTML = "";
      originalContainer.appendChild(img);
      uploadedImage = img;
    };
  });

  // ================== GERAR DESENHO ==================
  const generateButton = document.getElementById("generate-button");
  const colorPalette = document.getElementById("color-palette");

  generateButton.addEventListener("click", async () => {
    if (!uploadedImage) return alert("Envie uma imagem primeiro!");
    if (credits <= 0) return alert("Sem crÃ©ditos!");

    ctx.drawImage(uploadedImage, 0, 0, 400, 400);
    generatedContainer.innerHTML = "";
    canvas.classList.remove("hidden");
    colorPalette.classList.remove("hidden");

    await updateDoc(doc(db, "users", currentUser.uid), { credits: credits - 1 });
  });

  // ================== COLORIR (Flood Fill) ==================
  let selectedColor = "#f87171";
  document.querySelectorAll(".color-swatch").forEach((sw) => {
    sw.addEventListener("click", () => {
      document.querySelectorAll(".color-swatch").forEach((s) => s.classList.remove("selected"));
      sw.classList.add("selected");
      selectedColor = sw.dataset.color;
    });
  });

  canvas.addEventListener("click", (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor(e.clientX - rect.left);
    const y = Math.floor(e.clientY - rect.top);
    floodFill(x, y, hexToRgba(selectedColor), ctx);
  });

  function hexToRgba(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    return [ (bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255, 255 ];
  }

  function colorsMatch(c1, c2) {
    const tol = 32;
    return Math.abs(c1[0]-c2[0])<tol && Math.abs(c1[1]-c2[1])<tol && Math.abs(c1[2]-c2[2])<tol && Math.abs(c1[3]-c2[3])<tol;
  }

  function floodFill(x, y, fillColor, ctx) {
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imgData.data;
    const stack = [[x, y]];
    const base = getPixel(data, x, y, canvas.width);
    while (stack.length) {
      const [px, py] = stack.pop();
      const idx = (py * canvas.width + px) * 4;
      const current = [data[idx], data[idx+1], data[idx+2], data[idx+3]];
      if (colorsMatch(current, base)) {
        setPixel(data, px, py, canvas.width, fillColor);
        stack.push([px+1, py], [px-1, py], [px, py+1], [px, py-1]);
      }
    }
    ctx.putImageData(imgData, 0, 0);
  }

  function getPixel(data, x, y, w) {
    const i = (y*w+x)*4; return [data[i],data[i+1],data[i+2],data[i+3]];
  }

  function setPixel(data, x, y, w, color) {
    const i = (y*w+x)*4; data[i]=color[0]; data[i+1]=color[1]; data[i+2]=color[2]; data[i+3]=color[3];
  }
</script>
</body>
</html>
