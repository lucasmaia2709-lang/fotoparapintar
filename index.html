!DOCTYPE html>
<html lang="pt">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gerador de Desenhos para Colorir</title>
<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Baloo 2', cursive;
    background-color: #f0f9ff;
}
.loader {
    border: 4px solid #fde68a;
    border-top: 4px solid #38bdf8;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.image-container img, .image-container canvas {
    max-height: 400px;
    width: auto;
    max-width: 100%;
    border-radius: 1rem;
    object-fit: contain;
}
.image-container canvas {
    cursor: crosshair;
}
.color-palette {
    display: flex;
    gap: 5px;
    margin-top: 10px;
    justify-content: center;
}
.color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 0.25rem;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 0 2px rgba(0,0,0,0.5);
    transition: transform 0.2s;
}
.color-swatch.selected {
    transform: scale(1.2);
    border-color: #38bdf8;
}
</style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
<main class="main-container bg-white p-6 sm:p-8 rounded-2xl shadow-2xl max-w-5xl w-full">
    <!-- AUTENTICAÇÃO -->
    <div id="auth-section">
        <div class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-500">Bem-vindo! ✨</h1>
            <p class="text-gray-600 mt-2">Crie a sua conta ou faça login para começar.</p>
            <div id="auth-form-container" class="mt-6 max-w-sm mx-auto">
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="O seu email" required class="shadow-sm border-2 rounded-full w-full py-3 px-6 text-center mb-4 focus:ring-2 focus:ring-sky-400 outline-none">
                    <input type="password" id="login-password" placeholder="A sua palavra-passe" required class="shadow-sm border-2 rounded-full w-full py-3 px-6 text-center mb-6 focus:ring-2 focus:ring-sky-400 outline-none">
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-full font-bold text-lg transition-transform transform hover:scale-105">Entrar</button>
                </form>
                <form id="register-form" class="hidden">
                    <input type="email" id="register-email" placeholder="O seu email" required class="shadow-sm border-2 rounded-full w-full py-3 px-6 text-center mb-4 focus:ring-2 focus:ring-sky-400 outline-none">
                    <input type="password" id="register-password" placeholder="Crie uma palavra-passe" required class="shadow-sm border-2 rounded-full w-full py-3 px-6 text-center mb-6 focus:ring-2 focus:ring-sky-400 outline-none">
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white py-3 rounded-full font-bold text-lg transition-transform transform hover:scale-105">Criar Conta</button>
                </form>
            </div>
            <p class="text-sm text-gray-500 mt-4">
                <a href="#" id="auth-toggle-link" class="text-sky-600 hover:underline">Não tem uma conta? Registe-se aqui.</a>
            </p>
            <p id="auth-error" class="text-red-500 mt-4 font-semibold h-5"></p>
        </div>
    </div>

    <!-- CONTEÚDO DO APP -->
    <div id="app-content" class="hidden">
        <div class="text-center mb-8 relative">
            <div class="absolute top-0 right-0 flex items-center gap-4">
                 <span id="credits-display" class="font-bold text-lg text-green-600 bg-white px-3 py-1 rounded-full shadow-md">Créditos: 0</span>
                <button id="logout-button" class="text-gray-500 hover:text-red-600 font-bold text-2xl" title="Sair">&times;</button>
            </div>
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-600">Desenhos para Colorir! 🎨</h1>
            <p class="text-gray-600 mt-2 text-lg">Transforme qualquer foto numa página para colorir!</p>
        </div>

        <div class="flex justify-center mb-6">
            <label for="image-upload" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-3 px-8 rounded-full cursor-pointer font-bold text-lg transition-transform transform hover:scale-105">Anexar Foto</label>
            <input type="file" id="image-upload" accept="image/*" class="hidden">
        </div>

        <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-3">A Sua Foto Original</h2>
                <div id="original-image-container" class="image-container bg-sky-100 min-h-[250px] flex items-center justify-center rounded-2xl p-2 shadow-inner"></div>
            </div>
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-3">O Seu Desenho</h2>
                <div id="generated-image-container" class="image-container bg-sky-100 min-h-[250px] flex items-center justify-center rounded-2xl p-2 shadow-inner">
                    <p class="text-gray-500">Aguardando a sua foto...</p>
                </div>
                <div class="flex flex-col items-center mt-4">
                    <button id="color-button" class="bg-pink-500 hover:bg-pink-600 text-white py-2 px-6 rounded-full hidden transition-transform transform hover:scale-105">Colorir!</button>
                    <div id="color-palette" class="color-palette hidden mt-2">
                        <div class="color-swatch" style="background-color:#f87171;" data-color="#f87171"></div>
                        <div class="color-swatch" style="background-color:#fb923c;" data-color="#fb923c"></div>
                        <div class="color-swatch" style="background-color:#facc15;" data-color="#facc15"></div>
                        <div class="color-swatch" style="background-color:#4ade80;" data-color="#4ade80"></div>
                        <div class="color-swatch" style="background-color:#60a5fa;" data-color="#60a5fa"></div>
                        <div class="color-swatch" style="background-color:#a78bfa;" data-color="#a78bfa"></div>
                        <div class="color-swatch" style="background-color:#f472b6;" data-color="#f472b6"></div>
                         <div class="color-swatch" style="background-color:#ffffff; border: 1px solid #ccc;" data-color="#ffffff"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-center mt-8">
            <button id="generate-button" class="bg-sky-600 hover:bg-sky-700 text-white py-3 px-8 rounded-full font-bold text-lg hidden transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">Transformar em Desenho</button>
        </div>

        <div id="error-message" class="text-center text-red-500 mt-4 font-semibold h-5"></div>
    </div>
</main>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut,
        signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        onSnapshot,
        updateDoc,
        getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // ===================================================================================
    // PASSO 1: CONFIGURAÇÃO DO FIREBASE
    // As suas chaves foram inseridas aqui.
    // ===================================================================================
  // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    import { getAnalytics } from "firebase/analytics";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
    apiKey: "AIzaSyD6Jdnkfql5Ou6Na_BI8zDF6L2a_3JRZsY",
    authDomain: "fotoparapintar.firebaseapp.com",
    projectId: "fotoparapintar",
    storageBucket: "fotoparapintar.firebasestorage.app",
    messagingSenderId: "353615488725",
    appId: "1:353615488725:web:91a8f3ec55106381e8645c",
    measurementId: "G-CDVLBSL0SY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    
    // ===================================================================================
    // PASSO 2: CHAVE DE API DO GEMINI
    // ADICIONE A SUA CHAVE AQUI.
    // ===================================================================================
    const GEMINI_API_KEY = "AIzaSyBo90fWoREhClB8W3fuI4mD8_eEDrPYrKo";


    // --- VERIFICAÇÃO DE CONFIGURAÇÃO ---
    // Este bloco irá mostrar um erro e parar a app se as chaves não forem alteradas.
    if (firebaseConfig.apiKey.startsWith("A_SUA_") || GEMINI_API_KEY.startsWith("A_SUA_")) {
        document.querySelector('main').innerHTML = `
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-8 rounded-2xl shadow-2xl max-w-3xl w-full">
                <h1 class="text-2xl font-bold mb-4">Erro de Configuração Crítico</h1>
                <p class="mb-2">A aplicação não pode iniciar porque as chaves de API do Firebase ou do Gemini não foram configuradas corretamente no ficheiro <strong>index.html</strong>.</p>
                <p class="mb-4">Por favor, siga estes passos:</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>Abra o ficheiro <strong>index.html</strong> num editor de texto.</li>
                    <li>Encontre o objeto <code>firebaseConfig</code> e substitua-o pelo que copiou do seu painel Firebase.</li>
                    <li>Encontre a variável <code>GEMINI_API_KEY</code> e substitua o seu valor pela sua chave do Google AI Studio.</li>
                </ol>
                <p class="mt-4 font-semibold">O site não irá funcionar até que estas chaves sejam preenchidas com os seus valores reais.</p>
            </div>
        `;
        throw new Error("Configuração de API em falta. A execução foi interrompida.");
    }


    // --- INICIALIZAÇÃO DA APLICAÇÃO (NÃO PRECISA DE ALTERAR) ---
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Variáveis de estado
    let currentUser = null;
    let userCredits = 0;
    let originalImageBase64 = null;
    let currentColor = '#f87171';

    // Elementos do DOM
    const authSection = document.getElementById('auth-section');
    const appContent = document.getElementById('app-content');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const authToggleLink = document.getElementById('auth-toggle-link');
    const authError = document.getElementById('auth-error');
    const logoutButton = document.getElementById('logout-button');
    const creditsDisplay = document.getElementById('credits-display');
    const imageUpload = document.getElementById('image-upload');
    const resultsDiv = document.getElementById('results');
    const originalImageContainer = document.getElementById('original-image-container');
    const generatedImageContainer = document.getElementById('generated-image-container');
    const generateButton = document.getElementById('generate-button');
    const errorMessage = document.getElementById('error-message');
    const colorButton = document.getElementById('color-button');
    const colorPalette = document.getElementById('color-palette');

    // --- LÓGICA DE AUTENTICAÇÃO ---

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Utilizador autenticado:", user.isAnonymous ? "Anónimo" : user.email);
            currentUser = user;
            listenToUserData(user.uid);
            authSection.classList.add('hidden');
            appContent.classList.remove('hidden');
        } else {
            console.log("Nenhum utilizador autenticado. A tentar login anónimo...");
            currentUser = null;
            authSection.classList.remove('hidden');
            appContent.classList.add('hidden');
            try {
                await signInAnonymously(auth);
            } catch(error) {
                console.error("Falha no login anónimo. Causa provável: Domínio não autorizado no Firebase.", error);
                authError.textContent = "Erro de configuração. Verifique se o URL do site está nos 'domínios autorizados' do Firebase Auth.";
            }
        }
    });

    authToggleLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.toggle('hidden');
        registerForm.classList.toggle('hidden');
        if (registerForm.classList.contains('hidden')) {
            authToggleLink.textContent = 'Não tem uma conta? Registe-se aqui.';
        } else {
            authToggleLink.textContent = 'Já tem uma conta? Entre aqui.';
        }
        authError.textContent = '';
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        authError.textContent = '';
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await setupNewUser(userCredential.user);
        } catch (error) {
            console.error("Erro de registo:", error);
            authError.textContent = 'Erro ao registar: ' + error.message;
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        authError.textContent = '';
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error("Erro de login:", error);
            authError.textContent = 'Erro ao entrar: ' + error.message;
        }
    });

    logoutButton.addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Erro ao sair:", error);
        }
    });

    // --- LÓGICA DO FIRESTORE ---

    async function setupNewUser(user) {
        const userRef = doc(db, `users/${user.uid}`);
        await setDoc(userRef, { credits: 5, email: user.email });
    }

    function listenToUserData(userId) {
        const userRef = doc(db, `users/${userId}`);
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                userCredits = data.credits !== undefined ? data.credits : 0;
                creditsDisplay.textContent = `Créditos: ${userCredits}`;
            } else {
                 console.log(`A configurar novo perfil para o utilizador: ${userId}`);
                 setupNewUser({uid: userId, email: currentUser.email || "Anónimo"});
            }
        });
    }

    // --- LÓGICA DA APLICAÇÃO ---
    
    imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            originalImageBase64 = event.target.result;
            originalImageContainer.innerHTML = `<img src="${originalImageBase64}" alt="Sua foto original">`;
            generatedImageContainer.innerHTML = `<p class="text-gray-500">Pronto para transformar!</p>`;
            resultsDiv.classList.remove('hidden');
            generateButton.classList.remove('hidden');
            colorButton.classList.add('hidden');
            colorPalette.classList.add('hidden');
            errorMessage.textContent = '';
        };
        reader.readAsDataURL(file);
    });

    generateButton.addEventListener('click', async () => {
        if (!originalImageBase64 || !currentUser) {
            errorMessage.textContent = 'Por favor, anexe uma imagem primeiro.';
            return;
        }
        
        const userRefCheck = doc(db, `users/${currentUser.uid}`);
        const docSnap = await getDoc(userRefCheck);

        if (!docSnap.exists() || docSnap.data().credits <= 0) {
             errorMessage.textContent = 'Não tem créditos suficientes para gerar um desenho.';
             return;
        }
        
        generateButton.disabled = true;
        generateButton.textContent = 'A transformar...';
        generatedImageContainer.innerHTML = '<div class="loader"></div>';
        errorMessage.textContent = '';

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
            
            const base64Data = originalImageBase64.split(',')[1];
            const mimeType = originalImageBase64.match(/data:(.*);base64/)[1];

            const payload = {
                contents: [{
                    parts: [
                        { text: "Transforme esta imagem numa página de livro de colorir. O resultado deve ter contornos pretos, limpos e simples, sobre um fundo totalmente branco. Não adicione nenhuma cor." },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'A API retornou um erro.');
            }

            const result = await response.json();
            const generatedBase64 = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            
            if (generatedBase64) {
                const imageUrl = `data:image/png;base64,${generatedBase64}`;
                const img = new Image();
                img.onload = () => {
                    setupCanvasForColoring(img);
                };
                img.src = imageUrl;
                
                const userRef = doc(db, `users/${currentUser.uid}`);
                await updateDoc(userRef, { credits: userCredits - 1 });

            } else {
                throw new Error('A resposta da API não continha uma imagem.');
            }

        } catch (error) {
            errorMessage.textContent = `Ocorreu um erro: ${error.message}`;
            generatedImageContainer.innerHTML = '<p class="text-red-500">Falha ao gerar o desenho.</p>';
        } finally {
            generateButton.disabled = false;
            generateButton.textContent = 'Transformar em Desenho';
        }
    });
    
    function setupCanvasForColoring(img) {
         const canvas = document.createElement('canvas');
         const ctx = canvas.getContext('2d', { willReadFrequently: true });
         canvas.width = img.width;
         canvas.height = img.height;
         ctx.drawImage(img, 0, 0);
         generatedImageContainer.innerHTML = '';
         generatedImageContainer.appendChild(canvas);
         colorButton.classList.remove('hidden');
         
         canvas.addEventListener('click', (e) => {
             const rect = canvas.getBoundingClientRect();
             const scaleX = canvas.width / rect.width;
             const scaleY = canvas.height / rect.height;
             const x = Math.floor((e.clientX - rect.left) * scaleX);
             const y = Math.floor((e.clientY - rect.top) * scaleY);
             floodFill(ctx, x, y, hexToRgb(currentColor));
         });
    }

    colorButton.addEventListener('click', () => {
        colorPalette.classList.toggle('hidden');
    });

    colorPalette.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch')) {
            currentColor = e.target.dataset.color;
            document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('selected'));
            e.target.classList.add('selected');
        }
    });
    
    document.querySelector('.color-swatch').classList.add('selected');


    // --- LÓGICA DE COLORIR (FLOOD FILL) ---

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }

    function floodFill(ctx, x, y, fillColor) {
        const canvas = ctx.canvas;
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const targetColor = getPixel(data, canvas.width, x, y);

        if (colorsMatch(targetColor, [fillColor.r, fillColor.g, fillColor.b, 255])) {
            return;
        }

        const stack = [[x, y]];
        while (stack.length) {
            const [curX, curY] = stack.pop();

            if (curX < 0 || curX >= canvas.width || curY < 0 || curY >= canvas.height) continue;

            const currentColor = getPixel(data, canvas.width, curX, curY);

            if (colorsMatch(currentColor, targetColor)) {
                setPixel(data, canvas.width, curX, curY, fillColor);
                stack.push([curX + 1, curY]);
                stack.push([curX - 1, curY]);
                stack.push([curX, curY + 1]);
                stack.push([curX, curY - 1]);
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }
    
    function getPixel(data, width, x, y) {
        const index = (y * width + x) * 4;
        return [data[index], data[index + 1], data[index + 2], data[index + 3]];
    }

    function setPixel(data, width, x, y, color) {
        const index = (y * width + x) * 4;
        data[index] = color.r;
        data[index + 1] = color.g;
        data[index + 2] = color.b;
        data[index + 3] = 255;
    }

    function colorsMatch(c1, c2) {
        const tolerance = 32;
        return Math.abs(c1[0] - c2[0]) < tolerance && Math.abs(c1[1] - c2[1]) < tolerance && Math.abs(c1[2] - c2[2]) < tolerance && Math.abs(c1[3] - c2[3]) < tolerance;
    }

</script>
</body>
</html>

